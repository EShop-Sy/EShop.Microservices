api-version: 2024-02-02-preview
location: {{ .Env.AZURE_LOCATION }}
identity:
  type: UserAssigned
  userAssignedIdentities:
    ? "{{ .Env.AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID }}"
    : {}
properties:
  environmentId: {{ .Env.AZURE_CONTAINER_APPS_ENVIRONMENT_ID }}
  configuration:
    activeRevisionsMode: single
    runtime:
      dotnet:
        autoConfigureDataProtection: true
    ingress:
      external: true
      targetPort: 5000
      transport: http
      allowInsecure: false
    registries:
      - server: {{ .Env.AZURE_CONTAINER_REGISTRY_ENDPOINT }}
        identity: {{ .Env.AZURE_CONTAINER_REGISTRY_MANAGED_IDENTITY_ID }}
  template:
    containers:
      - image: {{ .Image }}
        name: api-gateway-mobile
        args:
          - /app/yarp.dll
        command: [dotnet]
        env:
          - name: AZURE_CLIENT_ID
            value: {{ .Env.MANAGED_IDENTITY_CLIENT_ID }}
          - name: ASPNETCORE_ENVIRONMENT
            value: Development
          - name: REVERSEPROXY__CLUSTERS__cluster_basket__DESTINATIONS__destination1__ADDRESS
            value: https+http://basket
          - name: REVERSEPROXY__ROUTES__route0__CLUSTERID
            value: cluster_basket
          - name: REVERSEPROXY__ROUTES__route0__MATCH__PATH
            value: /basket/{**catch-all}
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__0__PathRemovePrefix
            value: /basket
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__1__Append
            value: gateway.eshop.sy.com
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__1__RequestHeader
            value: X-Forwarded-Host
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__2__Append
            value: YARP
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__2__ResponseHeader
            value: X-Powered-By
          - name: REVERSEPROXY__ROUTES__route0__TRANSFORMS__2__When
            value: Success
          - name: services__basket__http__0
            value: http://basket.internal.{{ .Env.AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN }}
          - name: services__basket__https__0
            value: https://basket.internal.{{ .Env.AZURE_CONTAINER_APPS_ENVIRONMENT_DEFAULT_DOMAIN }}
    scale:
      minReplicas: 1
tags:
  azd-service-name: api-gateway-mobile
  aspire-resource-name: api-gateway-mobile
